# Redis Index Manager (Optimized) API æ–‡æ¡£

`RedisIndexManager` æ˜¯ä¸€ä¸ªåŸºäº Hash åˆ†æ¡¶ç­–ç•¥çš„é«˜æ€§èƒ½ Redis äºŒçº§ç´¢å¼•ç®¡ç†å™¨ã€‚å®ƒä¸“ä¸ºè§£å†³æµ·é‡æ•°æ®ä¸‹çš„ç´¢å¼•çƒ­ç‚¹é—®é¢˜è€Œè®¾è®¡ï¼Œæ”¯æŒé«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢ï¼ˆRange Scanï¼‰å’ŒåŸå­æ€§çš„æ•°æ®æ“ä½œã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

- **Hash åˆ†æ¡¶ (Sharding)**: å°†ç´¢å¼•æ•°æ®å‡åŒ€æ‰“æ•£åˆ°å¤šä¸ª ZSET ä¸­ï¼ˆé»˜è®¤ 256 ä¸ªæ¡¶ï¼‰ï¼Œé¿å…å• Key çƒ­ç‚¹é—®é¢˜ã€‚
- **Scatter-Gather æŸ¥è¯¢**: èŒƒå›´æŸ¥è¯¢æ—¶è‡ªåŠ¨å¹¶å‘æ‰«ææ‰€æœ‰ç›¸å…³æ¡¶ï¼Œå¹¶åœ¨å†…å­˜ä¸­è¿›è¡Œå½’å¹¶æ’åºã€‚
- **å†…å­˜ä¿æŠ¤**: é‡‡ç”¨åˆ†æ‰¹åˆå¹¶ (Incremental Merge) ç­–ç•¥ï¼Œæœ‰æ•ˆé˜²æ­¢å¤§èŒƒå›´ Scan å¯¼è‡´çš„å†…å­˜æº¢å‡º (OOM)ã€‚
- **åŸå­æ“ä½œ**: ä½¿ç”¨ Lua è„šæœ¬ä¿è¯æ•°æ® (KV) ä¸ç´¢å¼• (ZSET) çš„å¼ºä¸€è‡´æ€§ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–

æ”¯æŒä¼ å…¥ ioredis å®ä¾‹ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰æˆ– Redis é…ç½®å¯¹è±¡ï¼ˆæ¨èï¼Œæ”¯æŒå»¶è¿Ÿè¿æ¥ï¼‰ã€‚

```javascript
import Redis from "ioredis";
import { RedisIndexManager } from "./redis_index_manager_optimized.js";

// æ–¹å¼ A: ä¼ å…¥ ioredis å®ä¾‹
const redis = new Redis();
const manager = new RedisIndexManager({
  redis: redis,
  indexPrefix: "idx:", 
  hashChars: 2
});

// æ–¹å¼ B: ä¼ å…¥é…ç½®å¯¹è±¡ (Lazy Connect)
// è¿æ¥ä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ add/scan ç­‰æ–¹æ³•æ—¶è‡ªåŠ¨å»ºç«‹
const managerLazy = new RedisIndexManager({
  redis: {
    host: "127.0.0.1",
    port: 6379,
    // å…¶ä»– ioredis é…ç½®...
  },
  indexPrefix: "idx:",
  hashChars: 2
});
```

### 2. æ·»åŠ æ•°æ®

```javascript
// ä¼šåŒæ—¶åœ¨ Redis å†™å…¥ "user:1001" (String) å’Œ æ›´æ–°ç´¢å¼• (ZSET)
await manager.add("user:1001", JSON.stringify({ name: "Alice", age: 30 }));
```

### 3. èŒƒå›´æŸ¥è¯¢

```javascript
// æŸ¥è¯¢ user:1000 åˆ° user:1005 ä¹‹é—´çš„æ•°æ®
// è¿”å›æ ¼å¼: [key1, val1, key2, val2, ...]
const results = await manager.scan("user:1000", "user:1005", 10);

for (let i = 0; i < results.length; i += 2) {
  const key = results[i];
  const val = results[i + 1];
  console.log(key, val);
}
```

### 4. åˆ é™¤æ•°æ®

```javascript
// åŸå­åˆ é™¤æ•°æ®å’Œç´¢å¼•
await manager.del("user:1001");
```

---

## ğŸ“š API è¯¦è§£

### `constructor(options)`

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `redis` | `Redis \| Object` | - | **å¿…å¡«**ã€‚ioredis å®ä¾‹ï¼Œæˆ– ioredis æ„é€ å‡½æ•°é…ç½®å¯¹è±¡ï¼ˆæ”¯æŒ Lazy Connectï¼‰ã€‚ |
| `indexPrefix` | `string` | `"idx:"` | ç´¢å¼• ZSET çš„ Key å‰ç¼€ã€‚ |
| `hashChars` | `number` | `2` | Hash åˆ†æ¡¶ä½æ•° (Hex)ã€‚<br>`1`: 16 æ¡¶ (é€‚åˆåƒä¸‡çº§)<br>`2`: 256 æ¡¶ (é€‚åˆäº¿çº§ï¼Œæ¨è) |
| `scanBatchSize` | `number` | `50` | Scan æ—¶å¹¶å‘ Pipeline çš„æ‰¹æ¬¡å¤§å°ã€‚ |
| `mgetBatchSize` | `number` | `200` | å›æŸ¥ Value æ—¶ MGET çš„æ‰¹æ¬¡å¤§å°ã€‚ |

### `async add(key, value)`

åŸå­æ€§åœ°æ·»åŠ æ•°æ®å’Œç´¢å¼•ã€‚

- **Key**: æ•°æ®çš„å”¯ä¸€æ ‡è¯†ã€‚
- **Value**: æ•°æ®å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚
- **æ³¨æ„**: å¦‚æœç¯å¢ƒä¸æ”¯æŒ Lua è„šæœ¬ï¼Œä¼šè‡ªåŠ¨é™çº§ä¸º Pipeline æ¨¡å¼ï¼Œæ­¤æ—¶**ä¸ä¿è¯åŸå­æ€§**ï¼ˆæ§åˆ¶å°ä¼šè¾“å‡ºè­¦å‘Šï¼‰ã€‚

### `async del(key)`

åŸå­æ€§åœ°åˆ é™¤æ•°æ®å’Œç´¢å¼•ã€‚

### `async scan(startKey, endKey, limit)`

æ‰§è¡Œåˆ†å¸ƒå¼èŒƒå›´æŸ¥è¯¢ (Scatter-Gather Scan)ã€‚

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `startKey` | `string` | æ˜¯ | æ‰«æèµ·å§‹ Key (åŒ…å«)ã€‚ |
| `endKey` | `string` | å¦ | æ‰«æç»“æŸ Key (åŒ…å«)ã€‚<br>å¦‚æœæœªæä¾›ï¼Œå°è¯•æ ¹æ® `startKey` çš„åˆ†éš”ç¬¦ (`_`, `:`, `-`, `/`, `#`) è‡ªåŠ¨æ¨å¯¼å‰ç¼€èŒƒå›´ã€‚<br>æ¨å¯¼å¤±è´¥å°†æŠ›å‡ºé”™è¯¯ã€‚ |
| `limit` | `number` | å¦ | **å…¨å±€**è¿”å›æ•°é‡é™åˆ¶ (é»˜è®¤ 100)ã€‚<br>èŒƒå›´: 1 - 1000ã€‚ |

- **è¿”å›å€¼**: `Promise<Array<string>>`
  - è¿”å›ä¸€ä¸ªæ‰å¹³æ•°ç»„ï¼ŒKey å’Œ Value äº¤æ›¿æ’åˆ—ã€‚
  - ç¤ºä¾‹: `["user:1", "val1", "user:2", "val2"]`
  - å¦‚æœæœªæ‰¾åˆ°æ•°æ®ï¼Œè¿”å›ç©ºæ•°ç»„ `[]`ã€‚

### `async count(startKey, endKey)`

é«˜æ•ˆç»Ÿè®¡æŒ‡å®šèŒƒå›´å†…çš„ Key æ€»æ•°ã€‚

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `startKey` | `string` | æ˜¯ | ç»Ÿè®¡èµ·å§‹ Key (åŒ…å«)ã€‚ |
| `endKey` | `string` | å¦ | ç»Ÿè®¡ç»“æŸ Key (åŒ…å«)ã€‚è‡ªåŠ¨æ¨å¯¼é€»è¾‘åŒ `scan`ã€‚ |

- **è¿”å›å€¼**: `Promise<number>`
- **ç‰¹æ€§**: çº¯æœåŠ¡ç«¯è®¡ç®— (`ZLEXCOUNT`)ï¼Œæ— éœ€æ‹‰å–æ•°æ®ï¼Œé€Ÿåº¦æå¿«ä¸”ä¸æ¶ˆè€— Node.js å†…å­˜ã€‚

---

## âš ï¸ é™åˆ¶ä¸é£é™© (Limitations & Risks)

### 1. è¯»æ”¾å¤§ (Read Amplification)
ç”±äºé‡‡ç”¨äº† Hash åˆ†æ¡¶ç­–ç•¥ï¼Œæ•°æ®è¢«éšæœºæ‰“æ•£åˆ° 256 ä¸ªæ¡¶ä¸­ã€‚
- **å½±å“**: å³ä½¿ä½ åªéœ€è¦æŸ¥è¯¢ `limit=5` æ¡æ•°æ®ï¼Œ`scan` æ–¹æ³•ä¹Ÿå¿…é¡»**æ‰«ææ‰€æœ‰ 256 ä¸ªæ¡¶**ï¼Œç„¶ååœ¨å†…å­˜ä¸­æ’åºæˆªå– Top 5ã€‚
- **å»ºè®®**: é¿å…åœ¨é«˜é¢‘ï¼ˆQPS > 1000ï¼‰åœºæ™¯ä¸‹è°ƒç”¨ `scan`ï¼Œæˆ–å°† `hashChars` è®¾ç½®ä¸º 1 ä»¥å‡å°‘æ¡¶æ•°é‡ï¼ˆä½†è¿™ä¼šé™ä½å†™æ€§èƒ½ï¼‰ã€‚

### 2. åŸå­æ€§é™çº§é£é™©
- **åœºæ™¯**: åœ¨æŸäº› Redis é›†ç¾¤æ¨¡å¼ã€Proxy ç¯å¢ƒæˆ– Mock æµ‹è¯•ä¸­ï¼Œ`EVAL` (Lua è„šæœ¬) å¯èƒ½è¢«ç¦ç”¨ã€‚
- **åæœ**: ä»£ç ä¼šè‡ªåŠ¨é™çº§ä¸º `Pipeline` æ‰§è¡Œ `SET` + `ZADD`ã€‚
- **é£é™©**: å¦‚æœåœ¨ `SET` æˆåŠŸåå‘ç”Ÿç½‘ç»œæ•…éšœï¼Œ`ZADD` å¯èƒ½å¤±è´¥ï¼Œå¯¼è‡´â€œæ•°æ®å­˜åœ¨ä½†æ— æ³•è¢«ç´¢å¼•æŸ¥åˆ°â€çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚

### 3. å…¨è¡¨æ‰«æä¿æŠ¤
- **æœºåˆ¶**: ä¸ºäº†é˜²æ­¢è¯¯æ“ä½œå¯¼è‡´çš„å…¨è¡¨æ‰«æï¼ˆFull Scanï¼‰ï¼Œå¦‚æœæœªæä¾› `endKey` ä¸”æ— æ³•ä» `startKey` æ¨å¯¼èŒƒå›´ï¼Œ`scan` æ–¹æ³•ä¼šç›´æ¥æŠ›å‡º `Error`ã€‚
- **è§„é¿**: å§‹ç»ˆæ˜¾å¼æä¾› `endKey`ï¼Œæˆ–ç¡®ä¿ Key å‘½åç¬¦åˆè§„èŒƒï¼ˆåŒ…å«åˆ†éš”ç¬¦ï¼‰ã€‚

### 4. Limit é™åˆ¶
- **é™åˆ¶**: `limit` æœ€å¤§å…è®¸è®¾ç½®ä¸º **1000**ã€‚
- **åŸå› **: ä¸ºäº†é˜²æ­¢å†…å­˜æº¢å‡ºã€‚ç”±äºæ‰€æœ‰åˆ†æ¡¶çš„ç»“æœéƒ½éœ€è¦æ±‡æ€»åˆ° Node.js å†…å­˜ä¸­æ’åºï¼Œè¿‡å¤§çš„ Limit é…åˆé«˜å¹¶å‘è¯·æ±‚ææ˜“å¯¼è‡´ Node.js è¿›ç¨‹ OOM (Out of Memory)ã€‚

### 5. æ’åºæˆæœ¬
- **è¯´æ˜**: æ’åºæ˜¯åœ¨ Node.js å†…å­˜ä¸­è¿›è¡Œçš„ï¼ˆå­—å…¸åºï¼‰ï¼Œè€Œä¸æ˜¯åœ¨ Redis ç«¯å®Œæˆçš„ã€‚è¿™ä¼šæ¶ˆè€— Node.js çš„ CPU èµ„æºã€‚

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **Key å‘½åè§„èŒƒ**: ä½¿ç”¨åˆ†éš”ç¬¦ï¼ˆå¦‚ `user:1001`ï¼‰ï¼Œä»¥ä¾¿ `scan` è‡ªåŠ¨æ¨å¯¼èŒƒå›´ã€‚
2. **æ˜¾å¼ endKey**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå°½é‡æ˜¾å¼ä¼ å…¥ `endKey`ï¼Œæ˜ç¡®æ‰«æèŒƒå›´ã€‚
3. **ç›‘æ§**: ç›‘æ§ `scan` æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ã€‚å¦‚æœè€—æ—¶è¶…è¿‡ 500msï¼Œè¯´æ˜æ¡¶å†…æ•°æ®è¿‡å¤šæˆ–å¹¶å‘åº¦è¿‡é«˜ã€‚
4. **Value å¤§å°**: å°½é‡æ§åˆ¶ Value çš„å¤§å°ã€‚å¦‚æœ Value å¾ˆå¤§ï¼ˆå¦‚ > 10KBï¼‰ï¼Œ`scan` è¿”å›å¤§é‡æ•°æ®æ—¶ä¼šæ˜¾è‘—å¢åŠ ç½‘ç»œå¸¦å®½æ¶ˆè€—å’Œå†…å­˜å‹åŠ›ã€‚
