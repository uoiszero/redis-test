# Redis ZSet 性能测试报告

## 测试概述

本报告对比了 Redis 单机模式 (Singleton) 与集群模式 (Cluster) 在 ZSet 操作上的性能差异。测试数据量分别为 10,000 条和 100,000 条，以验证两种模式在不同规模数据下的表现。

## 测试环境

### 单机模式 (Singleton)
- 连接地址: `localhost:6379`
- 特点: 低延迟，适合本地开发/测试

### 集群模式 (Cluster)
- 连接地址:
  - `192.168.5.9:51002`
  - `192.168.5.10:51002`
  - `192.168.5.11:51002`
- 特点: 高可用、水平扩展，适合生产环境

### 测试配置
| 参数 | 小数据量测试 | 大数据量测试 |
|------|-------------|-------------|
| DATA_COUNT | 10,000 | 100,000 |
| FETCH_BATCH_SIZE | 100 | 1,000 |
| FETCH_TOTAL | 500 | 5,000 |
| BATCH_ADD_SIZE | - | 5,000 |
| BATCH_DELETE_SIZE | - | 5,000 |

---

## 测试结果

### 小数据量测试 (10,000 条)

| 测试项 | Singleton | Cluster | 性能差异 |
|--------|-----------|---------|----------|
| 添加 10,000 条数据 | 20ms | 1,489ms | **74x 慢** |
| 分批取出 500 条 | 2ms | 164ms | **82x 慢** |
| 删除整个 key | 1ms | 209ms | **209x 慢** |
| 完整流程总耗时 | 10ms | 1,052ms | **105x 慢** |

### 大数据量测试 (100,000 条)

| 测试项 | Singleton | Cluster | 性能差异 |
|--------|-----------|---------|----------|
| 添加 100,000 条数据 | 99ms | 5,246ms | **53x 慢** |
| 分批取出 5,000 条 | 3ms | 343ms | **114x 慢** |
| DEL 删除整个 key | 4ms | 8,288ms | **2,072x 慢** |
| ZREM 分批删除 | 44ms | 5,062ms | **115x 慢** |
| 完整流程总耗时 | 110ms | 10,737ms | **98x 慢** |

---

## 关键发现

### 1. 网络延迟是主要瓶颈

- **Singleton 模式**: 连接到 `localhost`，延迟极低 (亚毫秒级)
- **Cluster 模式**: 需要跨节点路由，存在明显的网络开销

### 2. 分批删除优化效果

| 删除方式 | Cluster 耗时 | 优化效果 |
|---------|--------------|---------|
| DEL (直接删除 key) | 8,288ms | - |
| ZREM (分批删除) | 5,062ms | **39% 提升** |

使用分批删除策略可以有效减少单次操作的响应时间。

### 3. 数据量对性能的影响

| 测试项 | 小数据量 (10k) 差异 | 大数据量 (100k) 差异 |
|--------|---------------------|---------------------|
| 添加 | 74x | 53x |
| 取出 | 82x | 114x |
| 删除 (DEL) | 209x | 2,072x |

随着数据量增加，Cluster 模式下删除操作的性能下降尤为明显。

---

## 原因分析

### 1. Redis Cluster 特性

- **数据分片**: ZSet 数据分散在多个槽位，涉及跨节点通信
- **路由开销**: 每次操作需要先路由到正确的节点
- **槽位遍历**: DEL 操作需要遍历所有槽位并删除数据

### 2. 网络因素

- 测试集群部署在 `192.168.5.x` 网段，存在局域网延迟
- 单次操作可能涉及多次网络往返

---

## 优化建议

### 对于 Redis Cluster 场景

1. **批量操作**: 使用 Pipeline 减少网络往返次数
2. **分批删除**: 对于大数据量删除，使用 SCAN + DEL 分批执行
3. **本地缓存**: 考虑使用本地缓存减少频繁的集群访问

### 何时选择哪种模式

| 场景 | 推荐模式 |
|------|---------|
| 本地开发/测试 | Singleton |
| 低延迟需求 | Singleton |
| 生产环境高可用 | Cluster |
| 大规模数据存储 | Cluster |

---

## 测试代码

测试代码位于 `test/zset.test.js`，支持通过环境变量切换模式：

```bash
# 单机模式
TEST_MODE=singleton node --test test/zset.test.js

# 集群模式
TEST_MODE=cluster node --test test/zset.test.js
```

---

## 结论

Redis Cluster 模式在提供高可用和水平扩展能力的同时，会产生额外的网络开销。在本测试中：

- **Singleton 模式** 平均比 Cluster 快 **50-2000 倍**
- 对于需要频繁删除大量数据的场景，建议使用分批删除策略
- 实际生产环境中，如果集群节点在同一局域网，延迟会有所改善
